{% extends "base.html" %}
{% import "bootstrap/wtf.html" as wtf %}


{% block page_content %}
    <div class="row">
        <div>
            <h2>设备运行状况统计 </h2>
        </div>
        {#        <div class="col-lg-6">#}
        {#            <a class="btn btn-info" href="{{ url_for("add_status_record") }}">添加记录</a>#}
        {#        </div>#}
        <div class="col-xs-2 col-lg-6"><span>状态：</span>
            {#            <select onchange="window.open(this.options[this.selectedIndex].value)">#}
            {#            <select onchange='document.location.href=this.options[this.selectedIndex].value'>#}
            {#                <option>---</option>#}
            {#                <option href="{{ url_for("devices") }}">正常</option>#}
            {#                <option href="{{ url_for("status_bro") }}">损坏</option>#}
            {#            </select>#}
            <select id="sl" onchange="window.location=this.options[this.selectedIndex].value">
                {#            <select>#}
                {% for status_type in status_types %}
                    <option value="{{ status_type.id }}" {% if status_type.id == type_id %}
                            selected {% endif %}>{{ status_type.name }}</option>
                {% endfor %}

            </select>
        </div>
        <form class="form-inline" method="post" role="form">
            {{ form.hidden_tag() }}
            {{ wtf.form_errors(form, hiddens="True") }}
            <div class="col-lg-6">
                <div class="input-group">
                    {{ form.name(class="form-control", placeholder="输入设备名进行查询") }}
                    <span class="input-group-btn">
	{{ wtf.form_field(form.submit) }}
	</span>
                </div>
            </div>
        </form>

    </div>
    <script>
        function set_dev_id1(dev_id) {
            document.getElementById("dev_id_label1").innerHTML = dev_id;
        }

        function set_dev_id2(dev_id) {
            document.getElementById("dev_id_label2").innerHTML = dev_id;
        }

        function submit_click1(dev_id) {
            let new_lab_id = document.getElementById("sl1").value;
            console.log(new_lab_id)
            window.location.href = "/status/modify/" + dev_id + "/" + new_lab_id;

        }

        function submit_click2(dev_id) {
            let price = document.getElementById("price_input").value;
            let m = document.getElementById("manufacturer_input").value;
            let username = document.getElementById("name_input").value;
            console.log(price);
            if (price.length === 0) {
                alert("价格不能为空！");
                return null;
            }
            if (m.length === 0) {
                alert("厂家不能为空！");
                return null;
            }
            if (username.length === 0) {
                alert("负责人不能为空");
                return null;
            }
            {#if (username === "{{ current_user.name }}") {#}
            {#    username = "{{ current_user.username }}";#}
            {# }#}
            {#window.location.href = "/lab_info/modify?lab_id=" + lab_id+ "&new_name=" + new_name;#}
            {#window.location.href = "{{ url_for('lab_info_modify', lab_id=lab_id, new_name=new_name ) }}";#}
            window.location.href = "/warranty_device/" + dev_id + "/" + price + "/" + m + "/" + username;
        }
    </script>
    <!--设备列表-->
    {% if statuses %}
        <table class="table table-striped table-condensed" id="table1">
            <thead>
            <tr>
                <th>序号</th>
                <th>设备编号</th>
                <th>设备名</th>
                <th>所在实验室名</th>
                <th>设备状态</th>
                <th>记录时间</th>
                <th>设备管理</th>
            </tr>
            </thead>
            {% for status in statuses %}
                <tr {% if status.status.name == "损坏" %} class="danger" {% endif %}>
                    <td>{{ loop.index }}</td>
                    <td>{{ status.dev_id }}</td>
                    <td>{{ status.device.name }}</td>
                    <td>{{ status.lab.name }}</td>
                    <td>{{ status.status.name }}</td>
                    <td>{{ status.time }}</td>

                    <td>
                        <a class="btn btn-success btn-sm {% if status.status.status_id == 3 %} disabled {% endif %} "
                           href="#" data-toggle="modal" data-target="#myModal1"
                           onclick="set_dev_id1({{ status.device_id }})">修改</a>
                        {#                        <a class="btn btn-primary btn-sm {% if status.status.status_id == 3 %} disabled {% endif %}"#}
                        {#                           href="{{ url_for('warranty_device', id=status.device_id,username=current_user.username) }}"#}
                        {#                           onclick="return confirm('确定要保修吗？');">保修</a>#}
                        {#                        <a class="btn btn-primary btn-sm {% if status.status.status_id == 3 %} disabled {% endif %}"#}
                        {#                           href="#" data-toggle="modal" data-target="#myModal1"#}
                        {#                           onclick="set_dev_id({{ status.device_id ,current_user.username }})">保修</a>#}
                        <a class="btn btn-primary btn-sm {% if status.status.status_id == 3 %} disabled {% endif %}"
                           href="#" data-toggle="modal" data-target="#myModal2"
                           onclick="set_dev_id2({{ status.device_id }})">保修</a>
                        <a class="btn btn-danger btn-sm  {% if status.status.status_id == 3 %} disabled {% endif %}"
                           href="{{ url_for('scrap_device',id=status.device_id,username=current_user.username) }}"
                           onclick="return confirm('确定要报废吗？');">报废</a>
                    </td>
                </tr>
            {% endfor %}
        </table>
        <div>共&nbsp;{{ status_num }}&nbsp;条记录 <br></div>
    {% else %}
        <p>看来没有符合条件的设备</p>
    {% endif %}


    <div class="modal fade" id="myModal1" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document" style="width: 500px;">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel2">修改设备所在实验室</h4>
                </div>
                <div class="modal-body">
                    <div class="form1 form2">
                        <ul class="row">
                            <div class="col-xs-15">
                                <div>设备ID为"<label id="dev_id_label1">xxx</label>"的设备：</div>
                                {#                            <div>新实验室为：</div>#}
                                {#                             onchange="window.location=this.options[this.selectedIndex].value"#}
                                <label for="sl1">新实验室为</label>
                                <select id="sl1">
                                    {% for lab in labs %}
                                        <option value="{{ lab.id }}">{{ lab.name }}</option>
                                    {% endfor %}
                                    <option value="0">未指定</option>
                                </select>
                            </div>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary"
                            onclick="submit_click1(document.getElementById('dev_id_label1').innerHTML)">
                        提交
                    </button>
                </div>
            </div>
        </div>
    </div>


    <div class="modal fade" id="myModal2" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document" style="width: 500px;">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel2">保修设备相关信息</h4>
                </div>
                <div class="modal-body">
                    <div class="form1 form2">
                        <ul class="row">
                            <div class="col-xs-15">
                                <div>保修ID为"<label id="dev_id_label2">xxx</label>"的设备</div>
                                <div>保修负责人：</div>
                                <input id="name_input" type="text" class="form-control" value="{{ current_user.name }}">
                                <div>保修厂家：</div>
                                <input id="manufacturer_input" type="text" class="form-control">
                                <div>保修价格：</div>
                                <input id="price_input" type="text" class="form-control">

                            </div>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary"
                            onclick="submit_click2(document.getElementById('dev_id_label2').innerHTML)">
                        提交
                    </button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}



